<canvas class="w-full" bind:this={canvas}>
</canvas>
<script>
import { onMount } from "svelte";
import { API } from "../api.js"
export let streamer_id;
let canvas;
let WordCloud;
let width;
let height;

let last_streamer_id = null;

$: if(WordCloud && last_streamer_id != streamer_id) {
  last_streamer_id = streamer_id;
  API.keywords(streamer_id).then(keywords => {
    keywords = keywords.filter(x => x[0] != "ㅋㅋ" && x[0] != "ㄷㄷ");
    let max_fraction = Math.max(...keywords.map(x => x[1])),
        min_fraction = Math.min(...keywords.map(x => x[1]));
    //keywords = keywords.map(x => [x[0], (x[1] - min_fraction)/(max_fraction-min_fraction)*120 + 9]);
    keywords = keywords.map(x => [x[0], (x[1] - min_fraction)/(max_fraction-min_fraction)*9.2 + 0.8]);
    let area = keywords.reduce((res,b) => res + b[0].length*b[1], 0);
    WordCloud(canvas, {
      list: keywords,
      gridSize: Math.round(16 * width / 1024),
      weightFactor: width / 1024 * 32 * 380/area,
      fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji',
      fontWeight: "bold",
      color: 'random-dark',
      backgroundColor: 'transparent',
      rotateRatio: 0,
      rotationSteps: 1
      ,  ellipticity: 1,
      /*shape: function(theta) {
        var max = 195;
        var leng = [134,135,135,135,135,135,135,135,135,135,135,135,135,136,136,136,136,136,137,137,137,138,138,138,138,139,139,140,140,140,141,141,142,142,143,143,144,144,145,145,146,147,147,148,149,149,150,151,152,153,153,154,155,156,157,158,159,160,161,162,163,164,165,167,168,169,170,172,173,175,176,178,179,181,182,184,186,188,189,191,193,195,195,193,192,190,188,187,185,184,182,181,179,178,177,175,174,173,172,171,169,168,167,166,165,164,163,163,162,161,160,159,158,158,157,156,155,155,154,154,153,152,152,151,151,150,150,149,149,148,148,148,147,147,146,146,146,145,145,145,145,144,144,144,144,144,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,144,144,144,144,144,145,145,145,145,146,146,146,147,147,147,148,148,149,149,150,150,151,151,152,152,153,153,154,155,155,156,157,157,158,159,160,161,162,162,163,164,165,166,167,168,169,170,172,173,174,175,176,178,179,180,182,183,185,186,188,190,191,193,195,193,191,189,187,185,183,182,180,178,177,175,174,172,171,169,168,167,166,164,163,162,161,160,159,158,157,156,155,154,153,152,151,150,150,149,148,147,147,146,145,145,144,143,143,142,142,141,141,140,140,139,139,138,138,138,137,137,136,136,136,136,135,135,135,134,134,134,134,134,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,134,134,134,134,134,135,135,135,135,136,136,136,137,137,137,138,138,139,139,140,140,140,141,142,142,143,143,144,144,145,146,146,147,148,149,149,150,151,152,153,154,154,155,156,157,158,159,160,160,158,156,154,152,150,148,146,144,143,141,139,138,136,135,133,132,131,129,128,127,126,124,123,122,121,120,119,118,117,116,115,114,114,113,112,111,110,111,109,108,108,110,112,114,116,118,120,122,125,127,130,133,136,139,142,145,149,149,147,144,140,136,135,131,129,126,125,121,120,118,115,114,113,110,108,107,105,103,102,101,100,97,96,95,94,93,92,92,92,92,92,92,93,92,92,92,92,92,92,92,92,92,92,92,92,92,93,92,92,92,93,93,93,93,93,93,94,94,94,94,94,95,95,95,95,96,96,96,97,97,97,98,98,98,99,99,100,101,101,101,102,102,103,103,104,104,105,105,106,107,107,108,109,109,110,111,112,112,113,114,115,116,117,118,119,120,121,121,121,121,122,122,122,122,121,121,121,121,122,122,122,122,122,122,122,122,123,123,123,123,123,123,123,124,124,124,125,125,125,125,126,126,126,127,127,128,128,129,129,130,130,131,131,132,132,133,133,134,134,135,136,136,137,138,139,140,139,139,139,138,138,138,137,137,137,137,136,136,136,136,136,135,135,135,135,135,135,135,135,135,135,135,136];

        return leng[(theta / (2 * Math.PI)) * leng.length | 0] / max;
      }*/
    });

  });
}
onMount(async ()=>{
  width = canvas.getBoundingClientRect().width,
  height = canvas.getBoundingClientRect().height;
  canvas.width = width;
  canvas.height = width;
  let { WordCloud:w } = await import('./wordcloud2.js');
  WordCloud = w;
});
</script>
